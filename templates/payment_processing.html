{% extends "base.html" %}

{% block content %}
<div class="max-w-3xl mx-auto text-center">
  
  <!-- Spinner animado -->
  <div class="mb-8 inline-block">
    <div class="w-24 h-24 mx-auto bg-gradient-to-br from-emerald-500 to-cyan-500 rounded-full flex items-center justify-center shadow-2xl shadow-emerald-500/50 animate-pulse">
      <svg class="animate-spin h-12 w-12 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
    </div>
  </div>

  <!-- TÃ­tulo -->
  <h1 class="text-4xl font-heading font-bold text-white mb-4" id="status-title">
    Procesando tu pago...
  </h1>
  
  <!-- DescripciÃ³n -->
  <p class="text-xl text-slate-300 mb-8" id="status-message">
    Espera un momento mientras verificamos tu suscripciÃ³n.
  </p>

  <!-- Tarjeta de informaciÃ³n -->
  <div class="bg-white/5 backdrop-blur-sm border border-white/10 rounded-2xl p-8 mb-8">
    <div class="space-y-4 text-left text-slate-300">
      <p>
        <strong class="text-white">Â¿QuÃ© estÃ¡ pasando?</strong>
      </p>
      <ul class="list-disc list-inside space-y-2 ml-4">
        <li>Recibimos tu pago correctamente âœ…</li>
        <li>Estamos activando tu suscripciÃ³n ğŸ”„</li>
        <li>Esto puede tomar hasta 30 segundos â±ï¸</li>
      </ul>
      <p class="text-sm text-slate-400 mt-4">
        <em>No cierres esta ventana. SerÃ¡s redirigido automÃ¡ticamente.</em>
      </p>
    </div>
  </div>

  <!-- Mensaje oculto de Ã©xito -->
  <div id="success-box" class="hidden bg-gradient-to-r from-emerald-500/10 to-cyan-500/10 border border-emerald-500/20 rounded-xl p-6 mb-8">
    <h3 class="text-2xl font-semibold text-white mb-2">Â¡Listo! ğŸ‰</h3>
    <p class="text-slate-300">Tu suscripciÃ³n ha sido activada correctamente.</p>
  </div>

</div>

<script>
  // Verificar estado del pago cada 3 segundos
  let checkCount = 0;
  const maxChecks = 20; // MÃ¡ximo 60 segundos (20 checks Ã— 3s)
  
  function checkPaymentStatus() {
    fetch('/payment/check-status')
      .then(response => response.json())
      .then(data => {
        checkCount++;
        
        if (data.status === 'completed') {
          // Pago confirmado
          document.getElementById('status-title').textContent = 'Â¡Pago Completado! ğŸ‰';
          document.getElementById('status-message').textContent = `Tu plan ${data.plan} estÃ¡ activo.`;
          document.getElementById('success-box').classList.remove('hidden');
          
          // Redirigir al dashboard despuÃ©s de 2 segundos
          setTimeout(() => {
            window.location.href = '/dashboard';
          }, 2000);
          
        } else if (checkCount >= maxChecks) {
          // Timeout despuÃ©s de 60 segundos
          document.getElementById('status-title').textContent = 'VerificaciÃ³n en curso';
          document.getElementById('status-message').textContent = 'Tu pago estÃ¡ siendo procesado. Te enviaremos un email cuando estÃ© listo.';
          
          // Redirigir al dashboard despuÃ©s de 5 segundos
          setTimeout(() => {
            window.location.href = '/dashboard';
          }, 5000);
          
        } else {
          // Continuar verificando
          setTimeout(checkPaymentStatus, 3000);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        // Reintentar en caso de error de red
        if (checkCount < maxChecks) {
          setTimeout(checkPaymentStatus, 3000);
        }
      });
  }
  
  // Iniciar verificaciÃ³n despuÃ©s de 2 segundos
  setTimeout(checkPaymentStatus, 2000);
</script>

<style>
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  .animate-spin {
    animation: spin 1s linear infinite;
  }
</style>
{% endblock %}