{% extends "base.html" %}
{% block content %}

<div class="flex gap-2 flex-col md:flex-row">

  <!-- ================= SIDEBAR ================= -->
<!-- ================= SIDEBAR ================= -->
  <aside id="sidebar"
    class="md:relative transform -translate-x-full transition-all duration-300 w-64 h-full z-50 bg-[#020617]/95 backdrop-blur-xl border-r border-white/10 md:translate-x-0">

    <!-- Logo -->
    <div>
      <div class="flex items-center gap-3 mb-4">
        <span class="text-xl text-center font-heading font-bold text-white">{{ current_user.workshop.name }}</span>
      </div>

      <hr class="pb-4">

      <!-- Nav -->
      <nav class="space-y-2 text-sm">
        <a href="/dashboard"
           class="flex items-center gap-3 px-4 py-2 rounded-xl bg-emerald-500/10 text-emerald-400 font-semibold transition-all duration-200 ease-in-out hover:text-white">
          üìä Dashboard
        </a>
        <a href="/jobs"
           class="flex items-center gap-3 px-4 py-2 rounded-xl text-slate-400 hover:bg-white/5 hover:text-white transition">
          üõ†Ô∏è Trabajos
        </a>
        <a href="/clients"
           class="flex items-center gap-3 px-4 py-2 rounded-xl text-slate-400 hover:bg-white/5 hover:text-white transition">
          üë• Clientes
        </a>
        <a href="/reports"
           class="flex items-center gap-3 px-4 py-2 rounded-xl text-slate-400 hover:bg-white/5 hover:text-white transition">
          üìà Reportes
        </a>
        <a href="#"
           class="flex items-center gap-3 px-4 py-2 rounded-xl text-slate-400 hover:bg-white/5 hover:text-white transition">
          ‚öôÔ∏è Configuraci√≥n
        </a>

        <!-- Nueva secci√≥n para Dashboard y Salir -->
        {% if current_user.is_authenticated %}
          <a href="/dashboard"
             class="flex items-center gap-3 px-4 py-2 rounded-xl bg-emerald-500/10 text-emerald-400 font-semibold transition-all duration-200 ease-in-out hover:text-white">
            üìä Dashboard
          </a>
          <a href="/logout"
             class="flex items-center gap-3 px-4 py-2 rounded-xl text-slate-400 hover:bg-white/5 hover:text-white transition">
            üö™ Salir
          </a>
        {% endif %}
      </nav>
    </div>

    <!-- User -->
    <div class="pt-6 border-t border-white/10 text-sm text-slate-400">
      {{ current_user.email }}
      <br>
      <a href="/forgot_password" class="text-sm text-emerald-400 hover:text-emerald-600">Actualizar contrase√±a</a>
    </div>
  </aside>


  <!-- FONDO OSCURECIDO PARA M√ìVIL -->
    <div id="sidebarOverlay"
     class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-40 md:hidden"></div>


  <!-- ================= MAIN ================= -->
  <main class="flex-1 space-y-8 px-4 md:px-6">

    <!-- Header -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
      <div>
        <h1 class="text-3xl font-heading font-bold text-white">
          Panel de Control
        </h1>
        <p class="text-slate-400 mt-1">
          Resumen general de tu taller
        </p>
      </div>

      <a href="/jobs/new"
         class="px-6 py-3 rounded-xl bg-gradient-to-r from-emerald-500 to-cyan-500 text-slate-900 font-bold hover:scale-[1.03] hover:shadow-[0_0_30px_rgba(16,185,129,0.45)] transition-all duration-300 ease-in-out">
        + Nuevo trabajo
      </a>
    </div>

    <!-- ================= PLAN ================= -->
    <section class="glass rounded-2xl p-5 border border-white/10 mb-8 transition-all duration-300 ease-in-out">
      <h2 class="text-xl font-heading font-bold text-white mb-4">Tu Plan</h2>
      <p class="text-slate-400">Plan actual: <strong class="text-white">{{ current_user.workshop.subscription.plan if current_user.workshop.subscription else 'Free' }}</strong></p>
      {% if not current_user.workshop.subscription or current_user.workshop.subscription.plan == 'free' %}
        <div id="planes" class="mt-4 space-x-2 mt-2 flex gap-2">
          <a href="/subscribe/basic" class="px-4 py-2 bg-blue-800 text-white rounded-lg font-bold transition-all duration-200 ease-in-out hover:bg-blue-700">Suscribir Basic ($9/mes)</a>
          <a id="planes-b" href="/subscribe/premium" class="px-4 py-2 bg-green-700 text-white rounded-lg font-bold transition-all duration-200 ease-in-out hover:bg-green-600">Suscribir Premium ($19/mes)</a>
        </div>
      {% endif %}
    </section>

    <!-- Estad√≠sticas -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
      <div class="glass rounded-2xl p-5 border border-white/10 transition-all duration-300 ease-in-out">
        <p class="text-slate-400 text-xs uppercase">Pendientes</p>
        <p class="mt-2 text-3xl font-bold text-white">
          {{ stats.pending }}
        </p>
      </div>

      <div class="glass rounded-2xl p-5 border border-cyan-500/20 transition-all duration-300 ease-in-out">
        <p class="text-slate-400 text-xs uppercase">En progreso</p>
        <p class="mt-2 text-3xl font-bold text-cyan-400">
          {{ stats.in_progress }}
        </p>
      </div>

      <div class="glass rounded-2xl p-5 border border-emerald-500/20 transition-all duration-300 ease-in-out">
        <p class="text-slate-400 text-xs uppercase">Completados</p>
        <p class="mt-2 text-3xl font-bold text-emerald-400">
          {{ stats.done }}
        </p>
      </div>

      <div class="glass rounded-2xl p-5 border border-white/10 transition-all duration-300 ease-in-out">
        <p class="text-slate-400 text-xs uppercase">Total trabajos</p>
        <p class="mt-2 text-3xl font-bold text-white">
          {{ stats.total }}
        </p>
      </div>
    </div>

    <!-- ================= ANALYTICS ================= -->
    <section class="glass rounded-2xl p-5 border border-white/10 mb-8 transition-all duration-300 ease-in-out">
      <h2 class="text-xl font-heading font-bold text-white mb-4">Analytics</h2>
      <canvas id="jobsChart" width="400" height="200"></canvas>
      {% if current_user.workshop.subscription and current_user.workshop.subscription.plan == 'premium' %}
        <p class="text-emerald-400 mt-4">üí° IA Recomendaci√≥n: Prioriza trabajos con prioridad alta para aumentar eficiencia en un 20%.</p>
      {% endif %}
    </section>

    <!-- ================= JOBS ================= -->
    <section class="space-y-4">
      <h2 class="text-xl font-heading font-bold text-white">Trabajos recientes</h2>

      {% if jobs|length == 0 %}
        <div class="text-center py-16 glass rounded-2xl border border-dashed border-white/10">
          <p class="text-slate-500">A√∫n no tienes trabajos creados.</p>
        </div>
      {% endif %}

      {% for job in jobs %}
      <a href="/jobs/{{ job.id }}"
         class="block p-5 rounded-2xl bg-slate-900/50 border border-white/5 hover:border-emerald-500/50 hover:bg-white/[0.03] transition-all duration-200 ease-in-out">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="font-bold text-white">{{ job.item }}</h3>
            <p class="text-sm text-slate-400">{{ job.client_name }} ¬∑ {{ job.created_at.strftime('%d/%m/%Y') }}</p>
          </div>

          {% if job.status == 'RECEIVED' %}
            <span class="px-3 py-1 rounded-full text-xs font-bold bg-slate-800 text-slate-300">
              Recibido
            </span>
          {% elif job.status == 'IN_PROGRESS' %}
            <span class="px-3 py-1 rounded-full text-xs font-bold bg-cyan-500/10 text-cyan-400">
              En taller
            </span>
          {% elif job.status == 'DONE' %}
            <span class="px-3 py-1 rounded-full text-xs font-bold bg-emerald-500/10 text-emerald-400">
              Listo
            </span>
          {% endif %}
        </div>
      </a>
      {% endfor %}
    </section>

  </main>
</div>

<script>
  const ctx = document.getElementById('jobsChart').getContext('2d');
  const jobsChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['Pendientes', 'En Progreso', 'Completados'],
      datasets: [{
        label: 'Trabajos',
        data: [{{ stats.pending }}, {{ stats.in_progress }}, {{ stats.done }}],
        backgroundColor: ['#ef4444', '#f59e0b', '#10b981'],
        borderColor: ['#dc2626', '#d97706', '#059669'],
        borderWidth: 1
      }]
    },
    options: {
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });
</script>

<script>
  const btn = document.getElementById("mobileMenuBtn");
  const sidebar = document.getElementById("sidebar");
  const overlay = document.getElementById("sidebarOverlay");

  // Toggle men√∫
  btn.addEventListener("click", () => {
    if (sidebar.classList.contains("-translate-x-full")) {
      sidebar.classList.remove("-translate-x-full");
      overlay.classList.remove("hidden");
    } else {
      sidebar.classList.add("-translate-x-full");
      overlay.classList.add("hidden");
    }
  });

  // Cerrar al tocar afuera
  overlay.addEventListener("click", () => {
    sidebar.classList.add("-translate-x-full");
    overlay.classList.add("hidden");
  });
</script>


<style>

  #sidebar {
    padding: 20px;
    border-radius: 30px;
    height: 80vh;
  }

  @media (max-width: 768px) {
    #sidebar {
      position: fixed;
      top: 0;
      left: 0;
      margin: 88px 18px;
      padding: 20px;
      border-radius: 30px;
      height: 80vh;
    }  
  }
  
  @media (max-width: 508px) {
  #planes {
    flex-direction: column;  
  }

  #planes-b {
    margin: 0;
  }

  }
</style>


{% endblock %}
